<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MEMORISE · Exploration Quiz</title>
  <style>
    :root {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
      background-color: #ffffff;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: #ffffff;
      color: #111827;
      display: flex;
      justify-content: center;
      padding: 20px 20px 16px;
    }

    .quiz-container {
      width: min(780px, 100%);
      min-height: calc(100vh - 64px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      padding-bottom: 32px;
    }

    .progress-area {
      display: flex;
      flex-direction: column;
      width: min(780px, 100%);
    }

    .progress-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .progress-track {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #111827;
      transition: width 200ms ease;
    }

    .quiz-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .quiz-header h1 {
      margin: 8px 0 4px;
      font-size: 1.8rem;
      font-weight: 600;
      text-align: center;
    }

    .quiz-brand {
      text-decoration: none;
      color: inherit;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .progress-count {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .progress-back {
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      color: #111827;
      cursor: pointer;
      visibility: hidden;
    }

    .progress-back:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .progress-back svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .quiz-note {
      margin: 0 0 4px;
      color: #6b7280;
      font-size: 0.95rem;
      text-align: center;
    }

    .options-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 55vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .option-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: left;
      font-size: 1rem;
      background: #fff;
      cursor: pointer;
      transition: border 150ms ease, background 150ms ease;
    }

    .option-heading {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #111827;
    }

    .option-emoji {
      font-size: 1.4rem;
    }

    .option-text {
      display: block;
      margin-top: 6px;
      font-size: 0.9rem;
      color: #6b7280;
    }

    .option-card:focus-visible {
      outline: 2px solid #111827;
      outline-offset: 2px;
    }

    .option-card.active {
      border-color: #111827;
      background: #f3f4f6;
    }

    .content-panel {
      width: min(480px, 100%);
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .next-card {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: auto;
      position: sticky;
      bottom: 16px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 16px;
      justify-content: center;
      width: min(520px, 100%);
      backdrop-filter: blur(10px);
    }

    .next-btn {
      width: 400px;
      height: 54px;
      border-radius: 999px;
      padding: 14px 32px;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      background: #111827;
      color: #ffffff;
    }
    .summary-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      background: #f9fafb;
      display: none;
    }

    .summary-card.visible {
      display: block;
    }

    .summary-card h2 {
      margin: 0 0 8px;
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 12px 0 24px;
      color: #374151;
    }

    .summary-list li {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.95rem;
    }

    .cta-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: #111827;
      color: #fff;
      padding: 12px 24px;
      text-decoration: none;
      font-size: 0.95rem;
    }
  </style>
  <style>
    @media (max-width: 1020px) {
      .progress-area {
        width: min(520px, 100%);
      }
    }
    @media (max-width: 640px) {
      body {
        padding: 12px 12px 16px;
      }
      .quiz-container {
        width: 100%;
      }
      .content-panel {
        width: 100%;
      }
      .options-grid,
      .option-card,
      .summary-card {
        width: 100%;
      }
      .summary-card {
        padding: 0;
      }
      .next-card {
        width: 100%;
      }
      .next-btn {
        width: 100%;
      }
    }

    .options-layout {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      width: 100%;
      flex-wrap: nowrap;
    }

    .options-layout .options-grid {
      flex: 1;
      order: 1;
    }

    .options-layout:not(.is-widget) .widget-container {
      display: none !important;
    }

@media (max-width: 900px) {
  .options-layout {
    position: relative;
    gap: 8px;
    align-items: stretch;
  }
  .options-grid {
    max-height: 55vh;
    padding-right: 74px;
  }
  .widget-container {
    position: fixed;
    top: 12%;
    bottom: 12%;
    right: 8px;
    transform: none;
    max-width: 64px;
    width: 64px;
    padding: 4px 0;
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.94) 50%);
    z-index: 20;
    display: flex;
    flex-direction: column;
  }
  .abc-letters {
    flex: 1;
    max-height: none;
    font-size: 0.64rem;
    flex-direction: column;
    flex-wrap: nowrap;
    align-items: center;
    justify-content: flex-start;
    overflow-y: hidden;
  }
}

.widget-container {
  width: 100%;
  background: transparent;
  border: none;
  border-radius: 0;
  padding: 2px 0;
  display: none;
  flex-direction: column;
  gap: 8px;
  max-width: 96px;
  order: 2;
  align-self: stretch;
  flex-shrink: 0;
  width: 96px;
}

    .widget-container.visible {
      display: flex;
    }

.abc-letters {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  width: 100%;
  gap: 2px;
  font-size: clamp(0.58rem, 1vw, 0.68rem);
  color: #64748b;
  letter-spacing: 0.04em;
  user-select: none;
  padding-right: 2px;
  overflow: visible;
  flex-wrap: nowrap;
}

.abc-letters .active-letter {
  color: #0f172a;
  font-weight: 700;
}

.abc-letters span {
  transition: transform 120ms ease, color 120ms ease;
  padding: 2px 3px;
  border-radius: 8px;
  width: 32px;
  text-align: center;
  display: block;
  line-height: 1.2;
}

.abc-letters span:hover {
  color: #0f172a;
  background: rgba(15, 23, 42, 0.06);
}

    @media (max-width: 900px) {
  .widget-container {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    max-width: 64px;
    width: 64px;
    padding: 2px 0;
  }
  .abc-letters {
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: center;
    gap: 2px;
    max-height: 42vh;
    width: 100%;
    padding-right: 0;
  }
  .abc-letters span {
    padding: 2px 3px;
    width: 28px;
  }
}
  </style>
</head>
<body>
  <main class="quiz-container">
    <div class="progress-area">
      <div class="progress-meta">
        <button class="progress-back" id="btnBack" type="button">
          <svg viewBox="0 0 24 24">
            <path d="M15 18l-6-6 6-6"></path>
          </svg>
        </button>
        <span class="progress-count" id="questionLabel">1 of 3</span>
      </div>
      <div class="progress-track">
        <div class="progress-bar" id="quizProgress"></div>
      </div>
    </div>
    <div class="content-panel">
      <div class="quiz-header">
        <h1 id="questionTitle"></h1>
      </div>

      <div class="options-layout" id="optionsLayout">
        <div class="widget-container" id="widgetContainer" hidden>
          <div class="abc-letters" id="abcLetters"></div>
        </div>

        <section class="options-grid" id="optionsGrid"></section>
      </div>
      <p class="quiz-note" id="questionSubtitle"></p>

      <div class="next-card" id="quizActions">
        <button class="next-btn" id="btnNext" type="button" disabled>Next</button>
      </div>

      <section class="summary-card" id="summaryCard">
        <h2>Ready to explore</h2>
        <p>We’ll tune the experience based on the following:</p>
        <ul class="summary-list" id="summaryList"></ul>
        <a class="cta-btn" href="/demo">
          Go to the map →
        </a>
      </section>
    </div>
  </main>

  <script>
    let steps = [];

    const quizProgress = document.getElementById("quizProgress");
    const questionLabel = document.getElementById("questionLabel");
    const questionTitle = document.getElementById("questionTitle");
    const questionSubtitle = document.getElementById("questionSubtitle");
    const optionsGrid = document.getElementById("optionsGrid");
    const btnBack = document.getElementById("btnBack");
    const btnNext = document.getElementById("btnNext");
    const summaryCard = document.getElementById("summaryCard");
    const summaryList = document.getElementById("summaryList");
    const quizActions = document.getElementById("quizActions");
    const optionsLayout = document.getElementById("optionsLayout");
    const widgetContainer = document.getElementById("widgetContainer");
    const abcLetters = document.getElementById("abcLetters");

    const answers = {};
    let currentStep = 0;
    const widgetState = {
      abcLetter: "A",
    };

    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    function renderAbcLetters() {
      if (!abcLetters) return;
      abcLetters.innerHTML = alphabet
        .map((ltr) => {
          const active = ltr === widgetState.abcLetter ? "active-letter" : "";
          return `<span class="${active}">${ltr}</span>`;
        })
        .join("");
    }

    function updateProgress() {
      if (!steps.length) return;
      const progress = ((currentStep + 1) / steps.length) * 100;
      quizProgress.style.width = `${progress}%`;
    }

    function renderStep() {
      if (!steps.length) return;
      const step = steps[currentStep];
      const autoAdvance = Boolean(step.autoAdvance);
      const useAbcWidget = step.widget === "abc_scroll";

      summaryCard.classList.remove("visible");
      optionsGrid.hidden = false;
      quizActions.hidden = autoAdvance;
      quizActions.style.display = autoAdvance ? "none" : "flex";
      optionsLayout.classList.toggle("is-widget", useAbcWidget);
      widgetContainer.hidden = !useAbcWidget;
      widgetContainer.classList.toggle("visible", useAbcWidget);

      questionLabel.textContent = `${currentStep + 1} of ${steps.length}`;
      questionTitle.textContent = step.title;
      questionSubtitle.textContent = step.subtitle || "";

      const currentAnswer = answers[step.id]?.value;
      if (useAbcWidget) {
        renderAbcLetters();
      }

      const activeLetter = useAbcWidget ? widgetState.abcLetter : null;
      const filteredOptions = useAbcWidget
        ? step.options.filter((opt) =>
            (opt.label || "").toUpperCase().startsWith(activeLetter || "A")
          )
        : step.options;
      const optionsToRender = filteredOptions;

      optionsGrid.innerHTML = optionsToRender
        .map(option => {
          const emoji = option.emoji ? `<span class="option-emoji" aria-hidden="true">${option.emoji}</span>` : "";
          const description = option.desc ? `<span class="option-text">${option.desc}</span>` : "";
          return `
            <button class="option-card ${currentAnswer === option.value ? "active" : ""}" data-value="${option.value}">
              <div class="option-heading">
                ${emoji}
                <span>${option.label}</span>
              </div>
              ${description}
            </button>
          `;
        })
        .join("");

      btnBack.disabled = currentStep === 0;
      btnBack.style.visibility = currentStep === 0 ? "hidden" : "visible";

      if (!autoAdvance) {
        btnNext.textContent = currentStep === steps.length - 1 ? "Finish" : "Next";
        btnNext.disabled = !currentAnswer;
      }

      updateProgress();
    }

    function finishQuiz() {
      try {
        localStorage.setItem("quizResults", JSON.stringify(answers));
      } catch (err) {
        console.error("Unable to store quiz results", err);
      }
      window.location.href = "/demo/newQuiz/myResults";
    }

    optionsGrid.addEventListener("click", (event) => {
      const card = event.target.closest(".option-card");
      if (!card) return;
      const value = card.dataset.value;
      const step = steps[currentStep];
      const selectedOption = step.options.find(opt => opt.value === value);
      answers[step.id] = {
        value,
        label: selectedOption?.label || value,
        emoji: selectedOption?.emoji || null
      };

      if (step.autoAdvance) {
        if (currentStep === steps.length - 1) {
          finishQuiz();
        } else {
          currentStep += 1;
          renderStep();
        }
        return;
      }

      renderStep();
    });

    btnBack.addEventListener("click", () => {
      if (currentStep === 0) return;
      currentStep -= 1;
      renderStep();
    });

    btnNext.addEventListener("click", () => {
      if (!answers[steps[currentStep].id]) return;
      if (currentStep === steps.length - 1) {
        finishQuiz();
      } else {
        currentStep += 1;
        renderStep();
      }
    });

    if (abcLetters) {
      function selectClosestLetter(clientX, clientY) {
        const spans = Array.from(abcLetters.querySelectorAll("span"));
        if (!spans.length) return false;
        let best = null;
        let bestDist = Infinity;
        spans.forEach((el) => {
          const rect = el.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          const dx = cx - clientX;
          const dy = cy - clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < bestDist) {
            bestDist = dist;
            best = el;
          }
        });
        if (!best) return false;
        const letter = best.textContent?.trim().toUpperCase();
        if (alphabet.includes(letter) && letter !== widgetState.abcLetter) {
          widgetState.abcLetter = letter;
          renderStep();
          return true;
        }
        return false;
      }

      abcLetters.addEventListener("click", (e) => {
        const span = e.target.closest("span");
        if (!span) return;
        const letter = span.textContent?.trim().toUpperCase();
        if (alphabet.includes(letter)) {
          widgetState.abcLetter = letter;
          renderStep();
        }
      });

      abcLetters.addEventListener("mousemove", (e) => {
        selectClosestLetter(e.clientX, e.clientY);
      });

      abcLetters.addEventListener("touchmove", (e) => {
        if (!e.touches || !e.touches.length) return;
        const touch = e.touches[0];
        selectClosestLetter(touch.clientX, touch.clientY);
      }, { passive: true });
    }

    async function initQuiz() {
      try {
        const res = await fetch("/static/quiz-steps.json", { cache: "no-cache" });
        steps = await res.json();
        renderStep();
      } catch (err) {
        console.error("Failed to load quiz steps", err);
      }
    }

    initQuiz();
  </script>
</body>
</html>
